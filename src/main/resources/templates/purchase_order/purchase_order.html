<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>구매 발주서 관리</title>
  <link rel="stylesheet" href="/css/purchase_order.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="icon" href="/image/favicon-32x32.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
<th:block th:replace="~{/fragments/fragment1}"></th:block>
<th:block th:replace="~{/fragments/fragment3 :: subnav(currentPageName='발주 관리 > 구매 발주서 관리')}"></th:block>
  <div class="container">
      <th:block th:replace="~{/fragments/fragment2}"></th:block>
    <div class="content">
      <section class="procurement-plan">
        <h2>구매 발주서 관리 - 조달 계획 리스트</h2>
        <button id="issue-order-btn" class="button">발주</button>
        <div class="search-bar">
          <div class="date-search">
            <input type="date" id="date-start" placeholder="시작 날짜"> <span>&nbsp; - &nbsp;&nbsp;</span> 
            <input type="date" id="date-end" placeholder="종료 날짜">
            <button id="date-search-btn">검색</button>
          </div>
          <div class="keyword-search">
            <select id="keyword-search-type">
              <option value="company">업체명</option>
              <option value="item">품목명</option>
            </select>
            <input type="text" id="keyword-search" placeholder="키워드 검색">
            <button id="keyword-search-btn">검색</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th><input type="checkbox"></th>
              <th>조달계획번호</th>
              <th>업체명</th>
              <th>품목명</th>
              <th>구매주문수량</th>
              <th>조달납기일</th>
              <th>사업자 번호</th> <!-- 새로 추가된 열 -->
              <th>품목 코드</th>
            </tr>
          </thead>
          <tbody id="procurement-plan-list">
            <tr  class="plan-row" th:each="plan : ${procurementPlans}">
              <td><input type="checkbox"></td>
              <td th:text="${plan.procPlanNumber}"></td>
              <td th:text="${plan.coOpCompany.companyName}"></td>
              <td th:text="${plan.item.itemName}"></td>
              <td><input type="number" name="procQuantity" class="input-field"></input></td>
              <td><input type="date" name="procDuedate" class="input-field"></input></td>
              <td th:text="${plan.coOpCompany.businessNumber}"></td>
              <td th:text="${plan.item.itemCode}"></td>
<!--              <td th:text="${plan.procQuantity}"></td>-->
<!--              <td th:text="${plan.procDuedate}"></td>-->
            </tr>
          </tbody>
        </table>
      </section>
      <section class="purchase-order">
        <h2>구매 발주서 관리 - 구매 발주서 리스트</h2>
        <button id="delete-order-btn" class="button">삭제</button>
        <button id="modify-order-btn" class="button">수정</button>
        <div class="search-bar">
          <div class="date-search">
            <input type="date" id="date-start" placeholder="시작 날짜"> <span>&nbsp; - &nbsp;&nbsp;</span> 
            <input type="date" id="date-end" placeholder="종료 날짜">
            <button id="date-search-btn">검색</button>
          </div>
          <div class="keyword-search">
            <select id="keyword-search-type">
              <option value="company">업체명</option>
              <option value="item">품목명</option>
            </select>
            <input type="text" id="keyword-search" placeholder="키워드 검색">
            <button id="keyword-search-btn">검색</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th><input type="checkbox"></th>
              <th>발주번호</th>
              <th>업체명</th>
              <th>품목명</th>
              <th>발주수량</th>
              <th>입고예정일</th>
              <th>발주일</th>
            </tr>
          </thead>
          <tbody id="purchase-order-list">

<!--            <tr th:each="purchase : ${purchasePlans}">-->
<!--                <td><input type="checkbox"></td>-->
<!--                <td th:text="${purchase.purchOrderNumber}"></td>-->
<!--                <td th:text="${purchase.purchOrderQuantity}"></td>-->
<!--                <td th:text="${purchase.receiveDuedate}"></td>-->
<!--                <td th:text="${purchase.purchOrderDate}"></td>-->
<!--            </tr>-->

          </tbody>
        </table>
      </section>

      <!-- 모달 창 -->
      <div id="orderModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>구매 발주서 관리 - 발주서 작성</h3>
            <div class="btn-group">
              <button id="saveOrder" class="button">저장</button>
              <button id="sendOrder" class="button">전송</button>
              <button id="printOrder" class="button">인쇄</button>
            </div>
          </div>
            <div id="image-container"></div>
          <button id="checkOrder" class="button">확인</button>
        </div>
      </div>

    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('#procurement-plan-list input[type="checkbox"]').forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
          if (this.checked) {
            let procPlanNumber = this.closest('tr').querySelector('td:nth-child(2)').innerText;

            fetch(`/procurement/getPlan?procPlanNumber=${procPlanNumber}`)
                    .then(response => {
                      if (response.ok) {
                        return response.json();
                      } else {
                        throw new Error('조달계획 정보를 불러오지 못했습니다.');
                      }
                    })
                    .then(data => {
                      let row = this.closest('tr');
                      row.querySelector('input[name="procQuantity"]').value = data.procQuantity;
                      row.querySelector('input[name="procDuedate"]').value = data.procDuedate;

                    })
                    .catch(error => {
                      alert(error.message);
                    });
          }
        });
      });

      document.getElementById('issue-order-btn').addEventListener('click', function () {
        let selectedPlans = [];
        document.querySelectorAll('#procurement-plan-list input[type="checkbox"]:checked').forEach(function (checkbox) {
          let row = checkbox.closest('tr');
          selectedPlans.push({
            procPlanNumber: row.querySelector('td:nth-child(2)').innerText,
            companyName: row.querySelector('td:nth-child(3)').innerText,
            itemName: row.querySelector('td:nth-child(4)').innerText,
            purchaseOrderQuantity: row.querySelector('input[name="procQuantity"]').value,
            receiveDuedate: row.querySelector('input[name="procDuedate"]').value,
            businessNumber: row.querySelector('td:nth-child(7)').innerText,
            itemCode: row.querySelector('td:nth-child(8)').innerText
          });
        });

        fetch('/purchase_order/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(selectedPlans)
        })
                .then(response => {
                  if (response.ok) {
                    return response.json();
                  } else {
                    throw new Error('발주서 생성을 실패했습니다.');
                  }
                })
                .then(data => {
                  alert('발주서가 성공적으로 생성되었습니다.');
                })
                .catch(error => {
                  alert(error.message);
                });
      });
    });

      // 모달 창 닫기 기능
      document.addEventListener('DOMContentLoaded', function () {
          var modal = document.getElementById('orderModal');

          window.onclick = function (event) {
              if (event.target == modal) {
                  modal.style.display = 'none';
              }
          };
      });

      $(document).ready(function() {
          // 페이지 로드 시 구매 발주서 리스트를 가져와서 표시하는 함수 호출
          fetchPurchaseOrders();

          // 구매 발주서 리스트를 가져와서 HTML에 표시하는 함수
          function fetchPurchaseOrders() {
              $.ajax({
                  url: '/purchase_order/list', // 서버의 해당 엔드포인트에 요청을 보냄
                  type: 'GET',
                  dataType: 'json',
                  success: function(data) {
                      displayPurchaseOrders(data); // 받아온 데이터를 화면에 표시하는 함수 호출
                  },
                  error: function(xhr, status, error) {
                      console.error('Failed to fetch purchase orders:', error);
                  }
              });
          }

          // 구매 발주서 데이터를 HTML에 표시하는 함수
          function displayPurchaseOrders(purchaseOrders) {
              var tableBody = $('#purchase-order-list');
              tableBody.empty(); // 기존 데이터를 지우고 새로운 데이터로 채움

              // 각 구매 발주서 데이터를 테이블에 추가
              $.each(purchaseOrders, function(index, purchaseOrder) {
                  var row = $('<tr>');
                  row.append('<td><input type="checkbox"></td>');
                  row.append('<td>' + purchaseOrder.purchOrderNumber + '</td>');
                  row.append('<td>' + purchaseOrder.coOpCompany.companyName + '</td>')
                  row.append('<td>' + purchaseOrder.item.itemName + '</td>')
                  row.append('<td>' + purchaseOrder.purchOrderQuantity + '</td>');
                  row.append('<td>' + purchaseOrder.receiveDuedate + '</td>');
                  row.append('<td>' + purchaseOrder.purchOrderDate + '</td>');
                  tableBody.append(row);
              });
          }
      });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.4.1/jspdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.5/dist/html2canvas.min.js"></script>
  <script src="/js/purchase_order.js"></script>
</body>
</html>