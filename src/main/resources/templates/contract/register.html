<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>계약 관리</title>
    <link rel="stylesheet" href="/css/contract.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="icon" href="/image/favicon-32x32.png">
    <script src="/js/jquery-3.7.1.min.js"></script>
</head>
<body>
<th:block th:replace="~{/fragments/fragment1}"></th:block>
<th:block th:replace="~{/fragments/fragment3 :: subnav(currentPageName='조달 관리 > 계약 등록')}"></th:block>

<div class="container">
    <th:block th:replace="~{/fragments/fragment2}"></th:block>

    <div class="content">
        <div class="registration-section">
            <h2>계약 등록 - 계약서</h2>
            <form id="contract-form" action="/contract/register" method="POST" enctype="multipart/form-data">
                <table>
                    <!--        <input type="hidden" name="coOpCompany" value="companyValueId">-->
                    <!--        <input type="hidden" name="item" value="itemValue">-->
                    <tr>
                        <th>계약서/첨부파일</th>
                        <td><input type="file" name="contractOriginName"></td>
                    </tr>
                    <tr>
                        <th>사업자 번호</th>
                        <td><input type="text" name="coOpCompany" class="input-field"></td>
                    </tr>
                    <tr>
                        <th>업체명</th>
                        <td><input type="text" name="companyName" class="input-field" readonly></td>
                    </tr>
                    <tr>
                        <th>계좌 정보</th>
                        <td><input type="text" name="companyAccount" class="input-field" readonly></td>
                    </tr>
                </table>
                <br>
                <h2>계약 등록 - 계약 항목</h2>
                <table class="save-section">
                    <tr>
                        <th>품목코드</th>
                        <th>품목명</th>
                        <th>단가</th>
                        <th>L/T(일)</th>
                        <th>세부사항</th>
                    </tr>
                    <tr>
                        <td><input type="text" name="itemCode" class="input-field" readonly></td>
                        <td><input type="text" name="itemName" class="input-field" readonly></td>
                        <td><input type="text" name="itemPrice"></td>
                        <td><input type="text" name="leadTime" ></td>
                        <td><input type="text" name="note" ></td>
                    </tr>
                </table>
                <button type="button" id="save-contract-button" class="save-button">저장</button>
            </form>
        </div>

        <div class="management-section">
            <h2>계약 관리</h2>
<!--            <div class="search-bar">
                <select name="search-option" id="search-option">
                    <option value="계약번호">계약번호</option>
                    <option value="품목명">품목명</option>
                    <option value="업체명">업체명</option>
                </select>
                <input type="text" placeholder="검색..." class="search-input">
                <button class="search-button">검색</button>
            </div>-->

            <div class="search-bar">
                <select name="search-option" id="search-option">
                    <option value="contractNumber">계약번호</option>
                    <option value="itemName">품목명</option>
                    <option value="companyName">업체명</option>
                </select>
                <input type="text" id="search-input" placeholder="검색..." class="search-input">
                <button id="search-button" class="search-button">검색</button>
            </div>

            <table id="contractManagementTable">
                <thead>
                <tr>
                    <th>품목코드</th>
                    <th>품목명</th>
                    <th>계약번호</th>
                    <th>업체명</th>
                    <th>사업자번호</th>
                    <th>단가</th>
                    <th>L/T(일)</th>
                    <th>수정</th>
                    <th>계약서</th>
                </tr>
                </thead>
                <tbody id="td-color">
                <tr th:each="item : ${items}">
                    <td class="item-row">
                        <span class="itemCode" th:text="${item.itemCode}"></span>
                        <span class="itemName" th:text="${item.itemName}" style="display: none;"></span>
                    </td>
                    <td th:text="${item.itemName}"></td>
                    <td>
                        <ul>
                            <th:block th:each="contract : ${item.contract}">
                                <li>
                                    <span th:text="${contract.contractNumber}"></span>
                                </li>
                            </th:block>
                        </ul>
                    </td>
                    <td>
                        <ul>
                            <th:block th:each="contract : ${item.contract}">
                                <li>
                                    <span th:text="${contract.coOpCompany.companyName}"></span>
                                </li>
                            </th:block>
                        </ul>
                    </td>
                    <td>
                        <ul>
                            <th:block th:each="contract : ${item.contract}">
                                <li>
                                    <span th:text="${contract.coOpCompany.businessNumber}"></span>
                                </li>
                            </th:block>
                        </ul>
                    </td>
                    <td>
                        <ul>
                            <th:block th:each="contract : ${item.contract}">
                                <li>
                                    <span th:text="${contract.itemPrice}"></span>
                                </li>
                            </th:block>
                        </ul>
                    </td>
                    <td>
                        <ul>
                            <th:block th:each="contract : ${item.contract}">
                                <li>
                                    <span th:text="${contract.leadTime}"></span>
                                </li>
                            </th:block>
                        </ul>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="pagination">
                <button class="pagination-button">이전</button>
                <span>1/10 페이지</span>
                <button class="pagination-button">다음</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        // 품목 행을 클릭했을 때 해당 품목의 정보를 계약 관리 테이블에 자동으로 채우기
        $("body").on("click", ".item-row", function () {
            var itemCode = $(this).find(".itemCode").text();
            var itemName = $(this).find(".itemName").text();

            // $("input[name='item']").val(itemCode);
            $("input[name='itemCode']").val(itemCode);
            $("input[name='itemName']").val(itemName);

        });

        $("#save-contract-button").click(function () {
            var formData = new FormData($("#contract-form")[0]);
            $.ajax({
                url: "/contract/register",
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log(response); // 응답 객체를 콘솔에 출력합니다.
                    if (Array.isArray(response)) { // 응답이 배열인지 확인합니다.
                        response.forEach(function(contract) {
                            $("#contractManagementTable tbody").append(
                                "<tr>" +
                                "<td>" + contract.itemCode + "</td>" +
                                "<td>" + contract.itemName + "</td>" +
                                "<td>" + contractNumber + "</td>" +
                                "<td>" + contract.companyName + "</td>" +
                                "<td>" + contract.coOpCompany.businessNumber + "</td>" +
                                "<td>" + contract.itemPrice + "</td>" +
                                "<td>" + contract.leadTime + "</td>" +
                                "<td><button class='edit-button'>수정</button></td>" +
                                "<td><button class='view-contract-button'>계약서</button></td>" +
                                "</tr>"
                            );
                        });
                    } else {
                        console.log('No contracts found');
                    }
                },
                error: function () {
                    alert("계약 등록에 실패하였습니다.");
                }
            });
        });

        // 사업자 번호를 입력했을 때 해당 업체 정보를 자동으로 채우기
        $("input[name='coOpCompany']").on("change", function () {
            var businessNumber = $(this).val();
            console.log("Business Number: " + businessNumber);
            $.ajax({
                url: "/contract/company",
                method: "GET",
                data: {
                    businessNumber: businessNumber,
                },
                success: function (response) {
                    console.log(response); // 서버 응답을 콘솔에 출력하여 확인
                    $("input[name='companyName']").val(response.companyName);
                    $("input[name='companyAccount']").val(response.companyAccount);
                },
                error: function () {
                    alert("업체 정보를 불러올 수 없습니다.");
                }
            });
        });
        // 확인 버튼 클릭 이벤트 핸들러
        document.getElementById('save-contract-button').addEventListener('click', () => {
            // 0.5초의 지연 추가
            setTimeout(() => {
                // 페이지 리다이렉션
                window.location.href = '/contract/register';
            }, 500); // 0.5초를 밀리초로 표기
        });
    });
</script>
<script src="contract.js"></script>
<script src="index.js"></script>
</body>
</html>